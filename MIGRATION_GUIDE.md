# 振動パターン設定機能の移行ガイド

## 概要

このドキュメントは、旧プリセット方式（短1／短2／長1／長2）から新しいカスタム振動パターン設定への移行について説明します。

## 主な変更点

### 旧仕様（プリセット方式）
- 短1: 100ms振動
- 短2: 100ms振動 → 200ms停止 → 100ms振動
- 長1: 400ms振動
- 長2: 100ms振動 → 200ms停止 → 400ms振動

### 新仕様（カスタムパターン）
ユーザーが以下の5つのフィールドを個別に設定可能：
1. **振動1** (必須): 100〜900ms（100ms刻み）
2. **停止1** (任意): 100〜900ms または「-」（無効）
3. **振動2** (任意): 100〜900ms または「-」（無効）
4. **停止2** (任意): 100〜900ms または「-」（無効）
5. **振動3** (任意): 100〜900ms または「-」（無効）

## 自動移行マッピング

既存のプリセット設定は以下のようにカスタムパターンに自動変換されます：

| 旧プリセット | 振動1 | 停止1 | 振動2 | 停止2 | 振動3 |
|-------------|-------|-------|-------|-------|-------|
| 短1         | 100ms | -     | -     | -     | -     |
| 短2         | 100ms | 200ms | 100ms | -     | -     |
| 長1         | 400ms | -     | -     | -     | -     |
| 長2         | 100ms | 200ms | 400ms | -     | -     |

## 新機能

### カスケード無効化
「-（無効）」を選択すると、それ以降のフィールドが自動的にグレーアウト（無効化）されます：

- **停止1 = -** を選択 → 振動2、停止2、振動3 が無効化
- **振動2 = -** を選択 → 停止2、振動3 が無効化
- **停止2 = -** を選択 → 振動3 が無効化

### テストボタン
各時報スロットにテストボタンが追加され、現在の設定を実機で確認できます：
- テスト実行中は、すべてのテストボタンが非活性化されます
- 振動完了後、自動的にボタンが再度有効化されます

## データ構造の変更

### QuarterSettings
```kotlin
data class QuarterSettings(
    val enabled: Boolean = false,
    val vibrationPatternId: String = "SHORT_1",  // 後方互換性のため保持
    val customPattern: CustomVibrationPattern? = null  // 新規追加
)
```

### CustomVibrationPattern
```kotlin
data class CustomVibrationPattern(
    val vib1: Int = 200,           // 必須（100-900ms）
    val pause1: Int? = null,       // 任意（nullで無効）
    val vib2: Int? = null,         // 任意（nullで無効）
    val pause2: Int? = null,       // 任意（nullで無効）
    val vib3: Int? = null          // 任意（nullで無効）
)
```

## 使用例

### 例1: シンプルな短い振動
- 振動1: 200ms
- 停止1: -
- その他: -

### 例2: 2回振動パターン
- 振動1: 100ms
- 停止1: 150ms
- 振動2: 100ms
- 停止2: -
- 振動3: -

### 例3: 複雑な3回振動パターン
- 振動1: 100ms
- 停止1: 200ms
- 振動2: 300ms
- 停止2: 200ms
- 振動3: 100ms

## テスト方法

1. 設定画面で希望の振動パターンを選択
2. 「テスト」ボタンを押して実機で確認
3. 必要に応じてパターンを調整
4. 時報が有効な状態で実際の時刻に確認

## トラブルシューティング

### 問題: 旧設定が正しく移行されない
**解決策**: アプリを一度アンインストールして再インストールしてください。設定は初期化されますが、クリーンな状態から始められます。

### 問題: テストボタンが押せない
**原因**: 別のテスト実行中の可能性があります。
**解決策**: 振動が完了するまで待ってから再度お試しください。

### 問題: 設定した振動パターンが実行されない
**確認事項**:
1. 時報スロットが有効になっているか
2. 正確なアラーム権限が許可されているか
3. 「振動1」に有効な値が設定されているか
